<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>新增消费</title>
    <link href="../frozenui/css/frozen.css" rel="stylesheet" />

    <script src="../frozenui/js/lib/zeptojs/zepto.min.js"></script>
    <script src="../frozenui/js/frozen.js"></script>
    <script src="../script/template.js"></script>
    <script src="../script/common.js"></script>
    <script src="../script/Duanjt.js"></script>
    <script src="../script/CusDate.js"></script>
    <script src="../script/DictionComb.js"></script>
    <script>
        $(function () {
            var cus = $(".ui-select-group").CusDate();

            var type = $("#CostTypeId").DictionComb({
                hiddenName: "CostTypeId",
                data: request("diction_list", { parentId: 1000300000 }).data
            });

            $("#btnSave").tap(function () {
                //验证输入是否合法
                if (!$("input[name=Reason]").val()) {
                    alertMsg("请输入消费名称");
                    return;
                }
                if (!$("input[name=Price]").val()) {
                    alertMsg("请输入消费金额");
                    return;
                }

                var val = {
                    Id: $("input[name=Id]").val(),
                    Time: cus.getTime(),
                    Reason: $("input[name=Reason]").val(),
                    Price: $("input[name=Price]").val(),
                    CostTypeId: $("select[name=CostTypeId]").val(),
                    Notes: $("textarea[name=Notes]").val(),
                    IsMark: $("input[name=IsMark]").attr("checked") ? "true" : "false",
                    FamilyPay: $("input[name=FamilyPay]").attr("checked") ? "true" : "false",
                    ImgUrl: $("input[name=ImgUrl]").val()
                };
                var result = request("lifing_save", { objString: JSON.stringify(val) });
                if (result.success == true) {
                    //清空数据
                    $("input[name=Id]").val("");
                    $("input[name=Reason]").val("");
                    $("input[name=Price]").val("");

                    document.getElementById("txtImgUrl").value = "";
                    document.getElementById("imgPic").src = "";
                    document.getElementById("imgUpload").value = "";

                    alertMsg("保存成功");
                } else {
                    alertMsgCenter(result.msg);
                }
            });

            //判断是新增还是修改
            var id = sessionStorage.getItem("life_id");//Duanjt.Url.GetPara(location.href)["id"];
            if (id) {
                var result = request("lifing_getbyid", { id: id });
                if (result.success) {
                    var index = result.data;
                    cus.setTime(index.Time);
                    $("input[name=Id]").val(index.Id);
                    $("input[name=Reason]").val(index.Reason);
                    $("input[name=Price]").val(index.Price);
                    $("select[name=CostTypeId]").val(index.CostTypeId);
                    $("textarea[name=Notes]").val(index.Notes);
                    $("input[name=ImgUrl]").val(index.ImgUrl);
                    document.getElementById("imgPic").src = index.ImgUrl;

                    if (index.IsMark == "true") {
                        $("input[name=IsMark]").prop("checked", true);
                    }
                    if (index.FamilyPay == "true") {
                        $("input[name=FamilyPay]").prop("checked", true);
                    }
                } else {
                    alertMsgCenter(result.msg);
                }
            } else {
                cus.setTime(new Date());
            }


        });

        window.onload = function () {
            document.getElementById("imgUpload").addEventListener('change', readFile, false);
        }

        function selectPic() {
            document.getElementById("imgUpload").click();
        }

        function clearPic() {
            document.getElementById("txtImgUrl").value = "";
            document.getElementById("imgPic").src = "";
            document.getElementById("imgUpload").value = "";
        }

        function readFile() {
            var file = this.files[0];
            if (!/image\/\w+/.test(file.type)) {
                alertMsgCenter("请确保文件为图像类型");
                return false;
            }

            if (file.size > 500 * 1024) {//不能大于500K
                alertMsgCenter("文件最大只支持500KB");
                return false;
            }

            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () {
                document.getElementById("txtImgUrl").value = this.result;
                document.getElementById("imgPic").src = this.result;
            }
        }
    </script>
</head>

<body>
    <header class="ui-header ui-header-positive ui-border-b">
        <ul class="ui-row-flex">
            <li class="ui-col ui-flex ui-flex-pack-start">
                <i class="ui-icon-return" onclick="history.back()"></i>
            </li>
            <li class="ui-col ui-flex ui-flex-pack-center">
                <h1>新增消费</h1>
            </li>
            <li class="ui-col ui-flex ui-flex-pack-end">
                <i class="" id="btnSave">保存</i>
            </li>
        </ul>
    </header>

    <section class="ui-container">
        <div class="ui-form ui-border-t">
            <form action="#" onsubmit="return false" autocomplete="off">
                <div class="ui-form-item ui-border-b">
                    <label>消费日期</label>
                    <div class="ui-select-group" data-value="">
                    </div>
                </div>
                <div class="ui-form-item ui-border-b">
                    <label>消费名称</label>
                    <input type="text" value="" name="Reason">
                </div>
                <div class="ui-form-item ui-border-b">
                    <label>消费金额</label>
                    <input type="number" value="{{Data.Money}}" name="Price">
                </div>
                <div class="ui-form-item ui-border-b">
                    <label>消费类型</label>
                    <div class="ui-select" id="CostTypeId" data-value="1">
                        <select>
                            <option>2014</option>
                            <option selected>2015</option>
                            <option>2016</option>
                        </select>
                    </div>
                </div>
                <div class="ui-form-item ui-border-b" style="height:80px;">
                    <label>消费备注</label>
                    <textarea style="height:60px; margin-top:10px;" name="Notes"></textarea>
                </div>
                <div class="ui-form-item ui-border-b" style="display:-webkit-box; -webkit-box-orient:horizontal">
                    <div style="-webkit-box-flex:1">
                        <label class="ui-checkbox">
                            <input type="checkbox" name="IsMark" value="1">特殊标识
                        </label>
                    </div>
                    <div style="-webkit-box-flex:1">
                        <label class="ui-checkbox">
                            <input type="checkbox" name="FamilyPay" value="1">家庭内支出
                        </label>
                    </div>
                </div>
                <div>
                    <div style="padding:2px 0 2px 0;">
                        <button class="ui-btn" id="btnSelectPic" onclick="selectPic()">选择图片</button>
                        <button class="ui-btn" id="btnClearPic" onclick="clearPic()">清除图片</button>
                    </div>
                    <img src="" id="imgPic" style="width:100%" />
                    <input type="file" id="imgUpload" style="visibility: hidden;" />
                    <input type="hidden" id="txtImgUrl" name="ImgUrl" />
                </div>
                <input type="hidden" name="Id" value="" />
            </form>
        </div>

    </section>

</body>

</html>